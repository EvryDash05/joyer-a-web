<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Lista de Productos</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body>
        <div class="container">
            <h1 class="my-4">Lista de Productos</h1>
            <table class="table table-bordered" id="productTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Imagen</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                    <!-- Los datos se cargarán dinámicamente -->
                </tbody>
            </table>
        </div>

        <!-- Modal para Editar Producto -->
        <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editProductModalLabel">Editar Producto</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editProductForm">
                            <div class="mb-3">
                                <label for="editProductName" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="editProductName" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="editProductDescription" class="form-label">Descripción</label>
                                <textarea class="form-control" id="editProductDescription" name="description" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="editProductPrice" class="form-label">Precio</label>
                                <input type="number" class="form-control" id="editProductPrice" name="price" required>
                            </div>
                            <div class="mb-3">
                                <label for="editProductStock" class="form-label">Stock</label>
                                <input type="number" class="form-control" id="editProductStock" name="quantity" required>
                            </div>
                            <input type="text" id="editProductId">
                            <button type="submit" class="btn btn-primary">Guardar cambios</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            const ENDPOINT_GET_PRODADMIN = 'http://localhost:8080/v1/api/getProducts';
            const ENDPOINT_EDIT_PRODUCT = 'http://localhost:8080/v1/api/updateProduct/';

            // JavaScript para cargar productos desde el servidor y actualizar la tabla
            async function loadProducts() {
                const response = await fetch(ENDPOINT_GET_PRODADMIN);
                if (!response.ok) {
                    throw new Error('Error al obtener los productos');
                }
                const products = await response.json();
                
                console.log(products);

                const tableBody = document.getElementById('productTableBody');
                tableBody.innerHTML = '';

                products.forEach(product => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.productId}</td>
                        <td>${product.name}</td>
                        <td>${product.description}</td>
                        <td>${product.price}</td>
                        <td>${product.stock}</td>
                        <td><img src="data:image/jpeg;base64,${product.img}" alt="Imagen del Producto" width="100"/></td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="openEditModal('${product.productId}', '${product.name}', '${product.description}', ${product.price}, ${product.stock})">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.productId}')">Eliminar</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            //editar producto
            function openEditModal(productId, productName, description, price, stock) {
                document.getElementById('editProductId').value = productId;
                document.getElementById('editProductName').value = productName;
                document.getElementById('editProductDescription').value = description;
                document.getElementById('editProductPrice').value = price;
                document.getElementById('editProductStock').value = stock;
                new bootstrap.Modal(document.getElementById('editProductModal')).show();
            }

            document.getElementById('editProductForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const productId = document.getElementById('editProductId').value;
                const data = Object.fromEntries(new FormData(e.target));
                console.log(data);

                const response = await fetch(ENDPOINT_EDIT_PRODUCT + productId, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({...data,productId})
                });

                if (response.ok) {
                    alert('Producto editado con éxito');
                    new bootstrap.Modal(document.getElementById('editProductModal')).hide();
                    loadProducts();
                } else {
                    alert('Error al editar el producto');
                }
            });

            //eliminar producto
            async function deleteProduct(productId) {
                if (confirm('¿Está seguro de que desea eliminar este producto?')) {
                    const response = await fetch(`http://localhost:8080/v1/api/deleteProduct/${productId}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        alert('Producto eliminado con éxito');
                        loadProducts(); // Recargar la lista de productos
                    } else {
                        alert('Error al eliminar el producto');
                    }
                }
            }

            // Carga los productos al cargar la página
            window.onload = loadProducts;
        </script>
    </body>
</html>
